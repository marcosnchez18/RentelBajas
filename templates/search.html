<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Clientes</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body { background-color: #f9f9f9; }
        .navbar { margin-bottom: 2rem; }
        .input-group { width: 50%; margin: 0 auto; }
        .table-container { display: flex; justify-content: center; }
        .table { width: calc(100% - 4cm); max-width: calc(100% - 4cm); margin: 0 auto; font-size: 0.85em; transition: width 0.3s ease; }
        .table-full-width { width: 95%; max-width: 95%; }
        .table th { background-color: #007bff; color: white; font-size: 0.85em; }
        .table th, .table td { text-align: center; vertical-align: middle; padding: 6px; border: 1px solid #ddd; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .table .text-left { text-align: left; }
        .badge-danger { background-color: #dc3545; }
        .product-icons { display: flex; justify-content: space-between; align-items: center; gap: 5px; }
        .product-icons .left { justify-content: flex-start; }
        .product-icons .center { justify-content: center; }
        .product-icons .right { justify-content: flex-end; }
        .wifi-tachado { color: red; position: relative; }
        .wifi-tachado::after { content: 'X'; position: absolute; top: 0; left: 10px; font-size: 1.2em; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#"><img src="../img/logo.png" alt="Logo" style="width: 50px;"></a>
        <div class="ml-auto">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="#">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Sobre nosotros</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Contacto</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="text-center my-4"><h1 class="mt-3">Buscar Cliente</h1></div>

        <form id="searchForm" class="mt-3">
            <div class="input-group">
                <select class="form-control" id="searchType" name="searchType">
                    <option value="dni">Buscar por DNI</option>
                    <option value="nombre">Buscar por Nombre</option>
                </select>
                <input type="text" class="form-control" id="searchValue" name="searchValue" placeholder="Introduzca el DNI o Nombre del cliente" required>
                <div class="input-group-append">
                    <button class="btn btn-primary" type="submit"><i class="fas fa-search"></i></button>
                </div>
            </div>
        </form>

        <div id="error" class="alert alert-danger mt-3" style="display:none;"></div>
        <div id="clienteData" style="display:none;">
            <div class="table-container">
                <table class="table table-hover mt-3">
                    <thead>
                        <tr>
                            <th>DNI</th>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>Teléfono Fijo</th>
                            <th>Teléfono Móvil</th>
                            <th>Dirección</th>
                            <th>Facturas Pendientes</th>
                            <th>Productos</th>
                            <th>Estado</th>
                            <th>Fecha Fin</th>
                        </tr>
                    </thead>
                    <tbody id="clienteTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.getElementById("searchForm").addEventListener("submit", async function(event) {
            event.preventDefault();
            const searchType = document.getElementById("searchType").value;
            const searchValue = document.getElementById("searchValue").value;

            try {
                const response = await fetch("http://10.58.6.89:8082/get_data_client_baja_for_dni", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ [searchType]: searchValue })
                });
                const data = await response.json();

                if (data.length === 0 || data.error) {
                    document.getElementById("error").style.display = "block";
                    document.getElementById("error").textContent = data.error || "No se encontraron datos para la búsqueda proporcionada.";
                    document.getElementById("clienteData").style.display = "none";
                } else {
                    document.getElementById("error").style.display = "none";
                    document.getElementById("clienteData").style.display = "block";
                    mostrarClientes(data);
                }
            } catch (error) {
                document.getElementById("error").style.display = "block";
                document.getElementById("error").textContent = "Error al conectar con la API.";
                document.getElementById("clienteData").style.display = "none";
            }
        });

        function mostrarClientes(clientes) {
            const clienteTableBody = document.getElementById("clienteTableBody");
            clienteTableBody.innerHTML = "";

            clientes.forEach((cliente) => {
                const productosContratados = `
                    <div class="product-icons">
                        <span class="left ${cliente.fechaFin < new Date().toISOString().split("T")[0] ? "wifi-tachado" : ""}">
                            ${cliente.Pfibra || cliente.Pint ? '<i class="fas fa-wifi"></i>' : ''}
                        </span>
                        <span class="center">${cliente.Pfijo ? '<i class="fas fa-phone"></i>' : ''}</span>
                        <span class="right">
                            ${cliente.PMovil ? '<i class="fas fa-mobile-alt"></i>' : ''}
                            ${cliente.Pcentralita ? '<i class="fas fa-phone-office"></i>' : ''}
                            ${cliente.Ptv ? '<i class="fas fa-tv"></i>' : ''}
                        </span>
                    </div>
                `;

                const row = `
                    <tr data-id="${cliente.id}" class="cliente-row">
                        <td>${cliente.dni}</td>
                        <td class="text-left">${cliente.nombre}</td>
                        <td class="text-left">${cliente.email || "No disponible"}</td>
                        <td>${cliente.telefonofijo}</td>
                        <td>${cliente.telefonomovil}</td>
                        <td class="text-left">${cliente.direccion}, ${cliente.poblacion}, ${cliente.codpostal}</td>
                        <td>${cliente.NFacPendientes || 0}</td>
                        <td>${productosContratados}</td>
                        <td>${cliente.Baja ? "Baja" : "Alta"}</td>
                        <td>${cliente.fechaFin}</td>
                    </tr>
                `;
                clienteTableBody.innerHTML += row;
            });

            document.querySelectorAll('.cliente-row').forEach(row => {
                row.addEventListener('click', function() {
                    const clienteId = this.getAttribute('data-id');
                    const cliente = clientes.find(c => c.id === parseInt(clienteId));

                    if (cliente) {
                        localStorage.setItem('clienteSeleccionado', JSON.stringify(cliente));
                        window.location.href = `cliente_formulario.html?id=${clienteId}`;
                    }
                });
            });
        }
    </script>
</body>
</html>
