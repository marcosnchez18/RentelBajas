<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resumen del Cliente</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h2>Resumen del Cliente</h2>
        <form id="clienteForm">
            <div class="form-group">
                <label for="dni">DNI:</label>
                <input type="text" class="form-control" id="dni" disabled>
            </div>
            <div class="form-group">
                <label for="nombre">Nombre:</label>
                <input type="text" class="form-control" id="nombre" disabled>
            </div>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" class="form-control" id="email">
            </div>
            <div class="form-group">
                <label for="telefono">Teléfono Fijo:</label>
                <input type="text" class="form-control" id="telefonofijo" disabled>
            </div>
            <div class="form-group">
                <label for="movil">Teléfono Móvil:</label>
                <input type="text" class="form-control" id="telefonomovil" disabled>
            </div>
            <div class="form-group">
                <label for="direccion">Dirección:</label>
                <input type="text" class="form-control" id="direccion" disabled>
            </div>
        </form>

        <h3 class="mt-5">Productos Contratados</h3>
        <div id="productosResumen"></div>
    </div>

    <script>
        // Obtener el DNI del cliente desde la URL
        const urlParams = new URLSearchParams(window.location.search);
        const clienteDNI = urlParams.get('dni');
        console.log("DNI obtenido de la URL:", clienteDNI);

        async function obtenerDatosCliente(dni) {
            try {
                const response = await fetch("http://10.58.6.89:8082/get_data_client_baja_for_dni", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ dni: dni })
                });
                const data = await response.json();

                if (!data || data.length === 0) {
                    document.getElementById("productosResumen").innerHTML = "<p>Error: Cliente no encontrado.</p>";
                    return;
                }

                const cliente = data[0];

                // Completar el formulario con los datos del cliente
                document.getElementById("dni").value = cliente.dni;
                document.getElementById("nombre").value = cliente.nombre;
                document.getElementById("email").value = cliente.email || "No disponible";
                document.getElementById("telefonofijo").value = cliente.telefonofijo;
                document.getElementById("telefonomovil").value = cliente.telefonomovil;
                document.getElementById("direccion").value = `${cliente.direccion}, ${cliente.poblacion}, ${cliente.codpostal}`;

                // Llamada para obtener productos del cliente usando el `id` obtenido
                obtenerResumenProductos(cliente.id);
            } catch (error) {
                console.error("Error al obtener datos del cliente:", error);
            }
        }

        async function obtenerResumenProductos(id) {
            const url = `http://10.58.6.89:8082/cliente/${id}/products`;

            try {
                const response = await fetch(url);
                const productos = await response.json();

                let resumenHTML = "";

                // Líneas Móviles
                if (productos.lineas_moviles && Object.keys(productos.lineas_moviles).length > 0) {
                    resumenHTML += `<h4>Líneas Móviles</h4><ul>`;
                    Object.values(productos.lineas_moviles).forEach(linea => {
                        resumenHTML += `
                            <li>
                                <input type="checkbox" class="form-check-input" id="movil_${linea.ID}">
                                <label for="movil_${linea.ID}" class="form-check-label">
                                    <strong>Número:</strong> ${linea.DDI}, 
                                    <strong>Tarifa:</strong> ${linea.NomTarifa}, 
                                    <strong>Operador:</strong> ${linea.Operador},
                                    <strong>Precio:</strong> ${linea.PvpCuotaTarifa}€, 
                                    <strong>Descripción:</strong> ${linea.Descripcion}, 
                                    <strong>Fecha Alta:</strong> ${linea.FechaAlta}
                                </label>
                            </li>`;
                    });
                    resumenHTML += `</ul>`;
                } else {
                    resumenHTML += `<h4>Líneas Móviles</h4><p>No hay líneas móviles contratadas.</p>`;
                }

                // Servicios Adicionales
                if (productos.servicios_adicionales && Object.keys(productos.servicios_adicionales).length > 0) {
                    resumenHTML += `<h4>Servicios Adicionales</h4><ul>`;
                    Object.values(productos.servicios_adicionales).forEach(servicio => {
                        resumenHTML += `
                            <li>
                                <input type="checkbox" class="form-check-input" id="servicio_${servicio.ID}">
                                <label for="servicio_${servicio.ID}" class="form-check-label">
                                    <strong>Descripción:</strong> ${servicio.Descripcion}, 
                                    <strong>Precio:</strong> ${servicio.Precio}€, 
                                    <strong>Referencia:</strong> ${servicio.Referencia}
                                </label>
                            </li>`;
                    });
                    resumenHTML += `</ul>`;
                } else {
                    resumenHTML += `<h4>Servicios Adicionales</h4><p>No hay servicios adicionales contratados.</p>`;
                }

                // Fijos
                if (productos.fijos && Object.keys(productos.fijos).length > 0) {
                    resumenHTML += `<h4>Fijos</h4><ul>`;
                    Object.values(productos.fijos).forEach(fijo => {
                        resumenHTML += `
                            <li>
                                <input type="checkbox" class="form-check-input" id="fijo_${fijo.ID}">
                                <label for="fijo_${fijo.ID}" class="form-check-label">
                                    <strong>Número:</strong> ${fijo.DDI}, 
                                    <strong>Precio con IVA:</strong> ${fijo.PrecioConIva}€
                                </label>
                            </li>`;
                    });
                    resumenHTML += `</ul>`;
                } else {
                    resumenHTML += `<h4>Fijos</h4><p>No hay servicios de fijos contratados.</p>`;
                }

                // Internet
                if (productos.internet && Object.keys(productos.internet).length > 0) {
                    resumenHTML += `<h4>Internet</h4><ul>`;
                    Object.values(productos.internet).forEach(internet => {
                        resumenHTML += `
                            <li>
                                <input type="checkbox" class="form-check-input" id="internet_${internet.ID}">
                                <label for="internet_${internet.ID}" class="form-check-label">
                                    <strong>Descripción:</strong> ${internet.Descripcion}, 
                                    <strong>Precio:</strong> ${internet.PVPConIva}€
                                </label>
                            </li>`;
                    });
                    resumenHTML += `</ul>`;
                } else {
                    resumenHTML += `<h4>Internet</h4><p>No hay servicios de internet contratados.</p>`;
                }

                document.getElementById("productosResumen").innerHTML = resumenHTML;
            } catch (error) {
                console.error("Error al obtener productos:", error);
            }
        }

        // Ejecutar la función para cargar datos al abrir la página
        obtenerDatosCliente(clienteDNI);
    </script>
</body>
</html>
